<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenLayers - Playgrounds Example</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css"
    />
    <style>
      html,
      body,
      #map {
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button onclick="loadPlaygrounds">load features</button>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <script>
      const wmsUrl = "http://localhost:8100/geoserver/wms";
      const layerName = "my:playground_areas";

      const wmsSource = new ol.source.ImageWMS({
        url: wmsUrl,
        params: {
          LAYERS: layerName,
          TILED: true,
        },
        serverType: "geoserver",
        crossOrigin: "anonymous",
      });

      const wmsLayer = new ol.layer.Image({
        source: wmsSource,
      });

      const map = new ol.Map({
        target: "map",
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
          }),
          wmsLayer,
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([126.9845375, 37.5633489], "EPSG:3857"),
          zoom: 12,
        }),
      });

      async function loadPlaygrounds() {
        const response = await fetch("http://localhost:3000/playground_areas");
        const playgrounds = await response.json();

        const geojson = {
          type: "FeatureCollection",
          features: playgrounds.map((playground) => ({
            type: "Feature",
            geometry: playground.area,
            properties: {
              id: playground.id,
              playground_name: playground.playground_name,
              address: playground.address,
            },
          })),
        };

        const vectorSource = new ol.source.Vector({
          features: new ol.format.GeoJSON().readFeatures(geojson, {
            featureProjection: "EPSG:3857",
          }),
        });

        const playgroundLayer = new ol.layer.Vector({
          source: vectorSource,
        });

        map.addLayer(playgroundLayer);
      }

      // Add a vector layer for the new playground area
      const newPlaygroundAreaSource = new ol.source.Vector({});
      const newPlaygroundAreaLayer = new ol.layer.Vector({
        source: newPlaygroundAreaSource,
      });
      map.addLayer(newPlaygroundAreaLayer);

      // Add a draw interaction to the map
      const draw = new ol.interaction.Draw({
        source: newPlaygroundAreaSource,
        type: "Polygon",
      });

      // Save the drawn feature to the backend
      draw.on("drawend", async (event) => {
        const feature = event.feature;
        const format = new ol.format.GeoJSON();

        console.debug(format);
        const playgroundAreaGeoJSON = format.writeFeatureObject(feature, {
          // from 3857 to 4326
          featureProjection: "EPSG:3857",
          dataProjection: "EPSG:4326",
        });
        console.debug(playgroundAreaGeoJSON);

        // Send the playground area to the backend
        try {
          const response = await fetch("http://localhost:3000/playgrounds", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(playgroundAreaGeoJSON),
          });
          const result = await response.json();
          console.log("Playground area saved:", result);
        } catch (error) {
          console.error("Error saving playground area:", error);
        }
      });

      map.addInteraction(draw);
    </script>
  </body>
</html>
